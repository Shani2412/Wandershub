<% layout("layouts/boilerplate") %>

<!-- ================= LISTING DETAILS ================= -->
<div class="row mt-3">
  <div class="col-8 offset-3">
    <h3><%= listing.title || "No title provided" %></h3>
  </div>

  <div class="card col-6 offset-3 show-card <%= listing.isSold ? 'sold' : '' %>">

    <!-- ================= IMAGE CAROUSEL ================= -->
    <% if (listing.images && listing.images.length > 0) { %>

      <div id="listingCarousel" class="carousel slide" data-bs-ride="carousel">

        <!-- Indicators -->
        <div class="carousel-indicators">
          <% listing.images.forEach((img, index) => { %>
            <button
              type="button"
              data-bs-target="#listingCarousel"
              data-bs-slide-to="<%= index %>"
              class="<%= index === 0 ? 'active' : '' %>"
              aria-current="<%= index === 0 ? 'true' : 'false' %>">
            </button>
          <% }) %>
        </div>

        <!-- Slides -->
        <div class="carousel-inner">
          <% listing.images.forEach((img, index) => { %>
            <div class="carousel-item <%= index === 0 ? 'active' : '' %>">
              <img
                src="<%= img.url %>"
                class="d-block w-100"
                style="height: 400px; object-fit: cover;"
                alt="Listing image <%= index + 1 %>"
              >
            </div>
          <% }) %>
        </div>

        <!-- Previous -->
        <button class="carousel-control-prev" type="button" data-bs-target="#listingCarousel" data-bs-slide="prev">
          <span class="carousel-control-prev-icon"></span>
        </button>

        <!-- Next -->
        <button class="carousel-control-next" type="button" data-bs-target="#listingCarousel" data-bs-slide="next">
          <span class="carousel-control-next-icon"></span>
        </button>

      </div>

    <% } else { %>

      <img
        src="/images/placeholder.jpg"
        class="card-img-top show-img"
        alt="No image available"
      />

    <% } %>

    <!-- ================= CARD BODY ================= -->
    <div class="card-body">
      <p class="card-text">

        <%= listing.description || "No description provided" %>
        <br /><br />

        <b>
          <% if (listing.price !== undefined && listing.price !== null && listing.price !== "") { %>
            ‚Çπ <%= Number(listing.price).toLocaleString("en-IN") %>
          <% } else { %>
            Price not available
          <% } %>
        </b>
        <br />

        <b>Location:</b> <%= listing.location || "N/A" %><br />
        <b>Country:</b> <%= listing.country || "N/A" %><br />

        <% if (listing.isSold) { %>
          <span class="badge badge-sold">SOLD OUT</span>
        <% } else { %>
          <span class="badge badge-available">AVAILABLE</span>
        <% } %>

      </p>
    </div>
  </div>
</div>

<!-- ================= SELLER ALERT ================= -->
<% if (
  currentUser &&
  isSeller &&
  listing.owner &&
  listing.owner._id.equals(currentUser._id) &&
  !listing.isSold &&
  listing.purchaseRequest &&
  listing.purchaseRequest.status === "pending"
) { %>
  <div class="row mt-3">
    <div class="col-6 offset-3">
      <div class="request-info">
        üîî You have a pending purchase request.
        <a href="/seller/requests">Review now</a>
      </div>
    </div>
  </div>
<% } %>

<!-- ================= ACTION BUTTONS ================= -->
<div class="btns row mt-3">
  <div class="col-12 d-flex justify-content-center gap-2">

    <% if (listing.isSold) { %>
      <button class="btn btn-secondary" disabled>SOLD OUT</button>

    <% } else if (
      currentUser &&
      listing.owner &&
      listing.owner._id.equals(currentUser._id)
    ) { %>

      <a href="/listings/<%= listing._id %>/edit" class="btn btn-dark">
        Edit
      </a>

      <form
        action="/listings/<%= listing._id %>?_method=DELETE"
        method="POST"
        style="display:inline;"
      >
        <button class="btn btn-danger">Delete</button>
      </form>

    <% } else { %>

      <% if (
        currentUser &&
        listing.purchaseRequest &&
        listing.purchaseRequest.status === "pending" &&
        listing.purchaseRequest.buyer &&
        listing.purchaseRequest.buyer.equals(currentUser._id)
      ) { %>

        <button class="btn btn-warning" disabled>Request Sent</button>

      <% } else if (currentUser && !listing.purchaseRequest) { %>

        <a href="/listings/<%= listing._id %>/buy" class="btn btn-success">
          BUY NOW
        </a>

      <% } %>

    <% } %>

    <a href="/listings" class="btn btn-dark">Back to Listings</a>
  </div>
</div>

<hr class="mt-4">

<!-- ================= REVIEWS ================= -->
<div class="row">
  <div class="col-8 offset-2">
    <h4>Leave a Review</h4>

    <% if (currentUser) { %>
      <form action="/listings/<%= listing._id %>/reviews" method="POST">
        <div class="mb-3">
          <label class="form-label">Rating</label>
          <input type="hidden" name="review[rating]" id="ratingInput" value="0" required />

          <div id="starRating" class="star-rating">
            <span data-value="1">‚òÖ</span>
            <span data-value="2">‚òÖ</span>
            <span data-value="3">‚òÖ</span>
            <span data-value="4">‚òÖ</span>
            <span data-value="5">‚òÖ</span>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Comment</label>
          <textarea name="review[comment]" rows="4" class="form-control" required></textarea>
        </div>

        <button class="btn btn-primary">Submit Review</button>
      </form>
    <% } else { %>
      <p class="text-muted">Login to leave a review.</p>
    <% } %>

    <hr class="mt-4">

    <% if (listing.reviews && listing.reviews.length > 0) { %>
      <h4>Reviews</h4>

      <% for (let review of listing.reviews) { %>
        <div class="card mb-3">
          <div class="card-body">
            <h6 class="mb-1">
              @<%= review.author ? review.author.username : "Deleted User" %>
            </h6>

            <div>
              <% for (let i = 1; i <= 5; i++) { %>
                <% if (i <= review.rating) { %>‚≠ê<% } else { %>‚òÜ<% } %>
              <% } %>
              (<%= review.rating %>/5)
            </div>

            <p><%= review.comment %></p>

            <% if (
              currentUser &&
              (
                (review.author && review.author._id.equals(currentUser._id)) ||
                (listing.owner && listing.owner._id.equals(currentUser._id))
              )
            ) { %>
              <form
                action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
                method="POST"
                style="display:inline;"
              >
                <button class="btn btn-sm btn-danger">Delete</button>
              </form>
            <% } %>
          </div>
        </div>
      <% } %>
    <% } else { %>
      <p>No reviews yet.</p>
    <% } %>
  </div>
</div>

<script>
  const stars = document.querySelectorAll("#starRating span");
  const ratingInput = document.getElementById("ratingInput");

  if (stars && ratingInput) {
    stars.forEach((star) => {
      star.addEventListener("click", () => {
        const value = star.dataset.value;
        ratingInput.value = value;
        stars.forEach((s) =>
          s.classList.toggle("active", s.dataset.value <= value)
        );
      });
    });
  }
</script>
