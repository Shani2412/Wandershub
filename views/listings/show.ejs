<% layout('/layouts/boilerplate') %>

<div class="row mt-3">
  <div class="col-8 offset-3">
    <h3><%= listing.title %></h3>
  </div>
  
  <div class="card col-6 offset-3 show-card">
    <img src="<%= listing.image %>" class="card-img-top show-img" alt="<%= listing.title %>" />
    <div class="card-body">
      <p class="card-text">
        <%= listing.description %> <br /><br />
        
        <% if (listing.price != null) { %>
          <b>&#8377;<%= listing.price.toLocaleString('en-IN') %></b> <br />
        <% } else { %>
          <b>Price not available</b> <br />
        <% } %>
        
        <b>Location:</b> <%= listing.location %> <br />
        <b>Country:</b> <%= listing.country %> <br />
        
        <% if (listing.isSold) { %>
          <span class="badge bg-danger">SOLD OUT</span>
        <% } else { %>
          <span class="badge bg-success">AVAILABLE</span>
        <% } %>
      </p>
    </div>
  </div>
</div>

<div class="btns row mt-3">
  <div class="col-12 d-flex justify-content-center gap-2">
    <a href="/listings/<%=listing._id%>/edit" class="btn btn-dark">Edit</a>
    
    <form action="/listings/<%=listing._id%>?_method=DELETE" method="POST" style="display: inline;">
      <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this listing?')">Delete</button>
    </form>
    
    <form action="/listings/<%= listing._id %>/buy?_method=PUT" method="POST" style="display: inline;">
      <button type="submit" class="btn <%= listing.isSold ? 'btn-secondary' : 'btn-success' %>" 
              <%= listing.isSold ? '' : '' %>>  
        <%= listing.isSold ? 'SOLD OUT' : 'BUY NOW' %>
      </button>
    </form>
    
    <a href="/listings" class="btn btn-dark">Back to Listings</a>
  </div>
</div>

<hr class="mt-4">

<!-- Reviews Section -->
<div class="row">
  <div class="col-8 offset-2">
    <h4>Leave a Review</h4>
    <form action="/listings/<%=listing._id%>/reviews" method="POST" novalidate class="needs-validation">
      <div class="mb-3">
        <label for="rating" class="form-label">Rating</label>
        <input type="range" name="review[rating]" id="rating" min="1" max="5" step="1" value="3" class="form-range" />
        <div class="d-flex justify-content-between">
          <span>1</span>
          <span>2</span>
          <span>3</span>
          <span>4</span>
          <span>5</span>
        </div>
        <p>Selected Rating: <span id="ratingValue">3</span></p>
      </div>
      
      <div class="mb-3">
        <label for="comment" class="form-label">Comments:</label>
        <textarea name="review[comment]" id="comment" cols="30" rows="5" 
                  class="form-control" required placeholder="Write your review here..."></textarea>
        <div class="invalid-feedback">Please enter your comment/review</div>
      </div>
      
      <button type="submit" class="btn btn-primary">Submit Review</button>
    </form>
    
    <hr class="mt-4">
    
    <!-- Display Reviews -->
    <% if(listing.reviews && listing.reviews.length > 0) { %>
      <h4>Reviews</h4>
      <% for(let review of listing.reviews) { %>
        <div class="card mb-3">
          <div class="card-body">
            <h6 class="card-title">Rating: 
              <% for(let i = 1; i <= 5; i++) { %>
                <% if(i <= review.rating) { %>
                  ⭐
                <% } else { %>
                  ☆
                <% } %>
              <% } %>
              (<%= review.rating %>/5)
            </h6>
            <p class="card-text"><%= review.comment %></p>
            <form action="/listings/<%=listing._id%>/reviews/<%=review._id%>?_method=DELETE" method="POST" style="display: inline;">
              <button type="submit" class="btn btn-sm btn-outline-danger">Delete Review</button>
            </form>
          </div>
        </div>
      <% } %>
    <% } else { %>
      <p>No reviews yet. Be the first to review!</p>
    <% } %>
  </div>
</div>

<script>
  // Rating slider update
  const ratingSlider = document.getElementById('rating');
  const ratingValue = document.getElementById('ratingValue');
  
  ratingSlider.addEventListener('input', function() {
    ratingValue.textContent = this.value;
  });

  // Form validation
  (function() {
    'use strict';
    window.addEventListener('load', function() {
      var forms = document.getElementsByClassName('needs-validation');
      var validation = Array.prototype.filter.call(forms, function(form) {
        form.addEventListener('submit', function(event) {
          if (form.checkValidity() === false) {
            event.preventDefault();
            event.stopPropagation();
          }
          form.classList.add('was-validated');
        }, false);
      });
    }, false);
  })();
</script>